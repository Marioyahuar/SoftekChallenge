service: star-wars-pokemon-api

frameworkVersion: "3"

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-2'}
  timeout: 30
  memorySize: 512
  environment:
    STAGE: ${self:provider.stage}
    DB_HOST: ${env:DB_HOST}
    DB_NAME: ${env:DB_NAME}
    DB_USER: ${env:DB_USER}
    DB_PASSWORD: ${env:DB_PASSWORD}
    DB_PORT: ${env:DB_PORT, "3306"}
    REDIS_HOST: ${env:REDIS_HOST}
    REDIS_PORT: ${env:REDIS_PORT, "6379"}
    SWAPI_BASE_URL: "https://swapi.info/api/"
    POKEAPI_BASE_URL: "https://pokeapi.co/api/v2"
    COGNITO_USER_POOL_ID: ${env:COGNITO_USER_POOL_ID}
    CACHE_TTL_MINUTES: "30"
    API_RATE_LIMIT_RPM: "60"
    LOG_LEVEL: "debug"
    ADMIN_USER_IDS: ${env:ADMIN_USER_IDS}
    COGNITO_CLIENT_ID: ${env:COGNITO_CLIENT_ID}
    CACHE_TABLE_NAME: ${self:service}-${self:provider.stage}-cache
  tracing:
    lambda: true
    apiGateway: true
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - xray:PutTraceSegments
            - xray:PutTelemetryRecords
          Resource: "*"
        - Effect: Allow
          Action:
            - cloudwatch:PutMetricData
          Resource: "*"
        - Effect: Allow
          Action:
            - cognito-idp:GetUser
          Resource:
            - "arn:aws:cognito-idp:us-east-2:*:userpool/${env:COGNITO_USER_POOL_ID}"
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - Fn::GetAtt: [CacheTable, Arn]
  httpApi:
    authorizers:
      cognitoAuthorizer:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl: https://cognito-idp.us-east-2.amazonaws.com/${env:COGNITO_USER_POOL_ID}
        audience:
          - ${env:COGNITO_CLIENT_ID}

plugins:
  - serverless-plugin-typescript
  - serverless-offline
  - serverless-dotenv-plugin

custom:
  dotenv:
    path: .env
  serverless-offline:
    httpPort: 3000
    host: 0.0.0.0
    useChildProcesses: true

functions:
  fusedData:
    handler: src/infrastructure/adapters/http/handlers/fusedDataHandler.handler
    description: "Get fused Star Wars and Pokemon data with intelligent matching"
    events:
      - httpApi:
          path: /fusionados
          method: get
          cors:
            allowOrigins:
              - "*"
            allowHeaders:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
            allowMethods:
              - GET
              - OPTIONS

  customData:
    handler: src/infrastructure/adapters/http/handlers/customDataHandler.handler
    description: "Store custom user data with authentication"
    events:
      - httpApi:
          path: /almacenar
          method: post
          authorizer: cognitoAuthorizer
          cors:
            allowOrigins:
              - "*"
            allowHeaders:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
            allowMethods:
              - POST
              - OPTIONS

  history:
    handler: src/infrastructure/adapters/http/handlers/historyHandler.handler
    description: "Get paginated fusion history with authentication"
    events:
      - httpApi:
          path: /historial
          method: get
          authorizer: cognitoAuthorizer
          cors:
            allowOrigins:
              - "*"
            allowHeaders:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
            allowMethods:
              - GET
              - OPTIONS

resources:
  Resources:
    # DynamoDB Cache Table
    CacheTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-cache
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: cacheKey
            AttributeType: S
        KeySchema:
          - AttributeName: cacheKey
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true

    # CloudWatch Log Groups
    FusedDataLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: /aws/lambda/${self:service}-${self:provider.stage}-fusedData
        RetentionInDays: 14

    CustomDataLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: /aws/lambda/${self:service}-${self:provider.stage}-customData
        RetentionInDays: 14

    HistoryLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: /aws/lambda/${self:service}-${self:provider.stage}-history
        RetentionInDays: 14

    # API Gateway Configuration
    HttpApiGateway:
      Type: AWS::ApiGatewayV2::Api
      Properties:
        Name: ${self:service}-${self:provider.stage}
        ProtocolType: HTTP
        CorsConfiguration:
          AllowOrigins:
            - "*"
          AllowHeaders:
            - Content-Type
            - X-Amz-Date
            - Authorization
            - X-Api-Key
            - X-Amz-Security-Token
          AllowMethods:
            - GET
            - POST
            - OPTIONS
          MaxAge: 86400

  Outputs:
    ApiGatewayRestApiId:
      Value:
        Ref: HttpApiGateway
      Export:
        Name: ${self:service}-${self:provider.stage}-ApiGatewayRestApiId

    ApiEndpoint:
      Description: API Gateway endpoint URL
      Value:
        Fn::Join:
          - ""
          - - "https://"
            - Ref: HttpApiGateway
            - ".execute-api."
            - ${self:provider.region}
            - ".amazonaws.com/"
      Export:
        Name: ${self:service}-${self:provider.stage}-ApiEndpoint
